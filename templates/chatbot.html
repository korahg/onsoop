<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <title>ì˜¨ìˆ²</title>
  <style>
    :root { --bg-color:#ffffff; --text-color:#1f2937; --muted-color:#6b7280; --border-color:#e5e7eb; --accent-color:#3b82f6; --panel-bg:#f9fafb; --bot-bubble:#f3f4f6; --user-bubble:#dbeafe; }
    * { box-sizing:border-box; }
    body { margin:0; background:var(--bg-color); color:var(--text-color); font-family:'Pretendard',sans-serif; }
    .wrap { max-width:900px; margin:40px auto; padding:0 16px; }

    .header-bar { display:flex; align-items:flex-end; justify-content:space-between; margin-bottom:20px; gap:10px; flex-wrap:wrap; }
    .btn-group { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    h1 { font-size:32px; margin:0 0 8px; }
    .subtitle { color:var(--muted-color); }

    .card { background:var(--panel-bg); border:1px solid var(--border-color); border-radius:12px; padding:16px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.05); }

    .grid { display:grid; grid-template-columns: 1fr 280px; gap:16px; }

    /* ì±„íŒ… ì»¬ëŸ¼: ìœ„ì— ì±„íŒ…ì°½, ì•„ë˜ì— ì…ë ¥í¼ */
    .chat-column {
      display:flex;
      flex-direction:column;
      min-height:400px;
      gap:8px;
    }

    .chat-window { height:65vh; overflow-y:auto; margin-bottom:4px; padding:0 10px; background:#fff; border:1px solid var(--border-color); border-radius:10px; }
    .row { display:flex; margin-bottom:12px; gap:12px; align-items:flex-start; }
    .avatar { width:36px; height:36px; border-radius:50%; background:#e5e7eb; display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0; }
    .msg { padding:10px 14px; border-radius:12px; line-height:1.55; max-width:80%; white-space:pre-wrap; word-break:break-word; }
    .msg.bot { background:var(--bot-bubble); }
    .msg.user { background:var(--user-bubble); color:#1e3a8a; margin-left:auto; }

    form { display:flex; gap:8px; align-items:flex-end; }
    textarea { flex:1; min-height:56px; padding:16px; border-radius:10px; background:#fff; border:1px solid var(--border-color); font-size:16px; }
    button { padding:0 20px; cursor:pointer; border:none; border-radius:10px; font-weight:600; background:var(--accent-color); color:#fff; height:40px; }
    button.secondary { background:#e5e7eb; color:#374151; font-weight:500; font-size:14px; height:40px; padding:0 16px; }

    aside#emo-panel { border-left:1px solid var(--border-color); padding-left:12px; }
    #emo-panel h3{ margin:6px 0 10px; font-size:16px; }
    #emo-panel .rowbar{ display:flex; align-items:center; gap:8px; margin:6px 0; }
    #emo-panel .label{ width:44px; font-size:12px; color:#475569; }
    #emo-panel .bar{ flex:1; height:10px; background:#e5e7eb; border-radius:9999px; overflow:hidden; }
    #emo-panel .fill{ height:100%; width:0%; background:var(--accent-color); transition: width .35s ease; }
    #emo-panel .pct{ width:40px; text-align:right; font-size:12px; color:#334155; }

    /* ëª¨ë‹¬ */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      padding:16px;
    }
    .modal{
      width:100%;
      max-width:720px;
      background:#fff;
      border-radius:12px;
      border:1px solid var(--border-color);
      box-shadow:0 10px 30px rgba(0,0,0,.15);
    }
    .modal header{ padding:12px 16px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center; }
    .modal header h4{ margin:0; font-size:16px; }
    .modal .body{ padding:14px 16px; max-height:60vh; overflow:auto; white-space:pre-wrap; }
    .modal .footer{ padding:12px 16px; border-top:1px solid var(--border-color); display:flex; justify-content:flex-end; gap:8px; }

    /* ìŠ¤í‹°ì»¤ í† ìŠ¤íŠ¸ (í™•ëŒ€ ë²„ì „) */
    .sticker-toast{
      position: fixed;
      right: 24px; bottom: 26px;
      display: flex; align-items: center; gap: 14px;
      padding: 14px 16px;
      background: rgba(255,255,255,.96);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: 0 10px 28px rgba(0,0,0,.14);
      z-index: 60;
      animation: stickerIn .25s ease;
    }
    .sticker-toast img{ width: 84px; height: 84px; object-fit: contain; }
    .sticker-toast #sticker-caption{ font-weight: 800; color:#0f172a; font-size:18px; line-height: 1.2; }
    @media (max-width: 520px){
      .sticker-toast{ right: 12px; bottom: 16px; padding: 12px 14px; gap: 10px; }
      .sticker-toast img{ width: 68px; height: 68px; }
      .sticker-toast #sticker-caption{ font-size:16px; }
    }
    @keyframes stickerIn { from{ transform: translateY(8px); opacity: 0; } to{ transform: translateY(0); opacity: 1; } }

    /* ===== ëª¨ë°”ì¼ ë°˜ì‘í˜• íŠœë‹ ===== */
    @media (max-width: 768px){
      html, body {
        height:100%;
      }
      body{
        background:#f3f4f6;
      }
      .wrap{
        max-width:100%;
        margin:0;
        padding:12px 10px 16px;
      }
      .header-bar{
        flex-direction:column;
        align-items:flex-start;
        gap:12px;
        margin-bottom:12px;
      }
      h1{ font-size:24px; }
      .card{
        padding:12px;
        border-radius:18px;
      }
      .grid{
        display:flex;
        flex-direction:column;
        gap:16px;
      }
      .chat-column{
        min-height: calc(100vh - 260px);  /* í—¤ë”/ê°ì •íŒ¨ë„ ë¹¼ê³  ë‚¨ì€ ì˜ì—­ ì •ë„ */
      }
      .chat-window{
        flex:1;
        height:auto;               /* ë†’ì´ ê³ ì • ëŒ€ì‹  flexë¡œ ì±„ìš°ê¸° */
        padding:8px 10px;
      }
      form{
        margin-top:4px;
      }
      aside#emo-panel{
        border-left:none;
        border-top:1px solid var(--border-color);
        margin-top:4px;
        padding-left:0;
        padding-top:12px;
      }
    }

    @media (max-width: 640px){
      .modal-backdrop{
        align-items:flex-end;
        padding:0;
      }
      .modal{
        border-radius:16px 16px 0 0;
        width:100%;
        max-width:100%;
      }
      .modal .body{
        max-height:70vh;
      }
      .btn-group{
        width:100%;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header-bar">
      <div>
        <h1>ì˜¨ìˆ²</h1>
        <div class="subtitle">ëª¨ë“  ëŒ€í™”ëŠ” ì•”í˜¸í™”ë˜ì–´ ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤.</div>
      </div>

      <div class="btn-group">
        <button type="button" class="secondary" onclick="location.href='/history'">ìƒë‹´ ê¸°ë¡</button>
        <button type="button" id="analyzeBtn">ìƒë‹´ ë‚´ìš© ìš”ì•½</button>
        <button type="button" class="secondary" onclick="location.href='/reset'">ëŒ€í™” ì´ˆê¸°í™”</button>

        {% if consent_ok %}
          <form method="post" action="/consent/revoke" style="display:inline;">
            <button type="submit" class="secondary">ë™ì˜ ì² íšŒ</button>
          </form>
        {% else %}
          <button type="button" class="secondary" onclick="openConsent()">ë°ì´í„° ë™ì˜</button>
        {% endif %}

        {% if session.get('auth_user_email') %}
          <span style="color:#64748b; font-size:14px;">{{ session.get('auth_user_email') }}</span>
          <button type="button" class="secondary" onclick="location.href='/logout'">ë¡œê·¸ì•„ì›ƒ</button>
        {% else %}
          <button type="button" class="secondary" onclick="location.href='/login'">ë¡œê·¸ì¸</button>
          <button type="button" class="secondary" onclick="location.href='/register'">íšŒì›ê°€ì…</button>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <!-- ì¢Œ: ì±„íŒ… -->
        <div class="chat-column">
          <div id="chat-window" class="chat-window">
            {% if not history %}
              <div class="row"><div class="avatar">ğŸ¤–</div><div class="msg bot">ì•ˆë…•í•˜ì„¸ìš”, ì˜¨ìˆ²ì…ë‹ˆë‹¤. ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?</div></div>
            {% endif %}
            {% for m in history %}
              {% if m.role == 'assistant' %}
                <div class="row"><div class="avatar">ğŸ¤–</div><div class="msg bot">{{ m.content }}</div></div>
              {% else %}
                <div class="row"><div class="msg user">{{ m.content }}</div></div>
              {% endif %}
            {% endfor %}
          </div>

          <form id="chat-form" method="POST" action="{{ url_for('chatbot') }}">
            <textarea id="message-input" name="message" placeholder="í•˜ê³  ì‹¶ì€ ë§ì„ ì ì–´ì£¼ì„¸ìš”..." required></textarea>
            <button type="button" id="micBtn" class="secondary" style="height:56px;">ğŸ¤ ë§í•˜ê¸°</button>
            <button type="submit" style="height:56px;">ë³´ë‚´ê¸°</button>
          </form>
        </div>

        <!-- ìš°: ì‹¤ì‹œê°„ ê°ì • íŒ¨ë„ -->
        <aside id="emo-panel">
          <h3>ì‹¤ì‹œê°„ ê°ì • ë¶„í¬</h3>
          <div class="emo-row" data-emokey="ë†€ëŒ"></div>
          <div class="emo-row" data-emokey="ê³µí¬"></div>
          <div class="emo-row" data-emokey="í˜ì˜¤"></div>
          <div class="emo-row" data-emokey="ì¤‘ë¦½"></div>
          <div class="emo-row" data-emokey="í–‰ë³µ"></div>
          <div class="emo-row" data-emokey="ë¶„ë…¸"></div>
          <div class="emo-row" data-emokey="ìŠ¬í””"></div>
        </aside>
      </div>
    </div>
  </div>

  <!-- ìƒë‹´ ë‚´ìš© ìš”ì•½ ëª¨ë‹¬ -->
  <div id="summaryModal" class="modal-backdrop">
    <div class="modal">
      <header>
        <h4>ìƒë‹´ ë‚´ìš© ìš”ì•½</h4>
        <button class="secondary" onclick="closeSummary()">ë‹«ê¸°</button>
      </header>
      <div class="body" id="summaryBody">ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      <div class="footer">
        <button class="secondary" onclick="closeSummary()">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ë°ì´í„° ë™ì˜ ëª¨ë‹¬ -->
  <div id="consentModal" class="modal-backdrop" style="display:none;">
    <div class="modal">
      <header>
        <h4>ìƒë‹´ ë°ì´í„° ìˆ˜ì§‘Â·ì´ìš© ë™ì˜</h4>
        <button class="secondary" onclick="closeConsent()">ë‹«ê¸°</button>
      </header>
      <div class="body" style="line-height:1.6;">
        <p>ì„œë¹„ìŠ¤ í’ˆì§ˆ ê°œì„  ë° ìƒë‹´ ê¸°ë¡ ì œê³µì„ ìœ„í•´ ëŒ€í™” ë‚´ìš©(í…ìŠ¤íŠ¸)ê³¼ ê°ì • ë¶„ì„ ê²°ê³¼ë¥¼ ì €ì¥Â·ì²˜ë¦¬í•©ë‹ˆë‹¤.
        <br/>ë¯¼ê° ì •ë³´ê°€ í¬í•¨ë  ìˆ˜ ìˆì–´ <b>ëª…ì‹œì  ë™ì˜</b>ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
        <ul style="padding-left:18px;">
          <li>ì €ì¥ í•­ëª©: ëŒ€í™” í…ìŠ¤íŠ¸(ì•”í˜¸í™” ì €ì¥), ê°ì • ë¶„í¬ ë¡œê·¸</li>
          <li>ì´ìš© ëª©ì : ìƒë‹´ ê¸°ë¡ ì œê³µ, ìš”ì•½/ë¦¬í¬íŠ¸ ìƒì„±, í’ˆì§ˆ ê°œì„ </li>
          <li>ë³´ê´€ ê¸°ê°„: ì„œë¹„ìŠ¤ ì´ìš©ê¸°ê°„ ë™ì•ˆ(ì–¸ì œë“  ì² íšŒ ê°€ëŠ¥)</li>
        </ul>
        <form id="consentForm" method="post" action="/consent">
          <label style="display:flex; gap:8px; align-items:center; margin-top:8px;">
            <input type="checkbox" name="agree" id="agreeChk"/>
            <span>ìœ„ ë‚´ìš©ì„ ì´í•´í•˜ì˜€ìœ¼ë©°, ìƒë‹´ ë°ì´í„° ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.</span>
          </label>
          <div class="footer" style="justify-content:flex-end; margin-top:12px;">
            <button type="submit" id="agreeBtn" class="secondary" disabled>ë™ì˜í•˜ê³  ì‹œì‘</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ìŠ¤í‹°ì»¤(ì‘ì€ ê·¸ë¦¼) í† ìŠ¤íŠ¸ -->
  <div id="sticker-toast" class="sticker-toast" style="display:none;">
    <img id="sticker-img" alt="sticker" />
    <div id="sticker-caption"></div>
  </div>

  <script>
    const EMO_KEYS = ['ë†€ëŒ','ê³µí¬','í˜ì˜¤','ì¤‘ë¦½','í–‰ë³µ','ë¶„ë…¸','ìŠ¬í””'];
    const CONSENT_OK = {{ 'true' if consent_ok else 'false' }};
    const NEED_CONSENT = {{ 'true' if need_consent else 'false' }};

    function ensureRows() {
      document.querySelectorAll('#emo-panel .emo-row').forEach(row => {
        if (row.children.length === 0) {
          const label = document.createElement('div'); label.className = 'label'; label.textContent = row.dataset.emokey;
          const bar = document.createElement('div'); bar.className = 'bar';
          const fill = document.createElement('div'); fill.className = 'fill'; bar.appendChild(fill);
          const pct = document.createElement('div'); pct.className = 'pct'; pct.textContent = '0%';
          const line = document.createElement('div'); line.className = 'rowbar';
          line.appendChild(label); line.appendChild(bar); line.appendChild(pct);
          row.appendChild(line);
        }
      });
    }

    async function refreshEmotionPanel() {
      try {
        const res = await fetch('/emotion_mix', { cache: 'no-store' });
        const data = await res.json();
        const emos = (data && data.emotions) ? data.emotions : {};
        ensureRows();
        EMO_KEYS.forEach(k => {
          const row = document.querySelector(`#emo-panel .emo-row[data-emokey="${k}"]`);
          if (!row) return;
          const val = Math.max(0, Math.min(1, Number(emos[k] || 0)));
          const pct = Math.round(val * 100);
          const fill = row.querySelector('.fill');
          const pctBox = row.querySelector('.pct');
          if (fill) fill.style.width = pct + '%';
          if (pctBox) pctBox.textContent = pct + '%';
        });

        // === ìŠ¤í‹°ì»¤ ì²˜ë¦¬ ===
        showStickerIfAny(data && data.sticker ? data.sticker : null);

      } catch (e) { console.warn('emotion_mix error', e); }
    }

    // ìš”ì•½ ëª¨ë‹¬
    const sModal = document.getElementById('summaryModal');
    const bodyEl = document.getElementById('summaryBody');
    function openSummary() { sModal.style.display = 'flex'; }
    function closeSummary() { sModal.style.display = 'none'; }
    async function fetchSummary() {
      try {
        bodyEl.textContent = 'ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
        openSummary();
        const res = await fetch('/analyze_session', { method: 'POST' });
        const data = await res.json();
        const cleaned = (data && data.analysis ? data.analysis : 'ìš”ì•½ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.')
                          .replace(/\*\*(.*?)\*\*/gs, '$1').replace(/__(.*?)__/gs, '$1').replace(/`(.*?)`/gs, '$1');
        bodyEl.textContent = cleaned;
      } catch (e) {
        bodyEl.textContent = 'ìš”ì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      }
    }
    document.getElementById('analyzeBtn').addEventListener('click', fetchSummary);

    // í¼ ì „ì†¡ ì§í›„ í•œ ë²ˆ ê°±ì‹ (ì¦‰ì‹œ ë°˜ì˜ ì²´ê°)
    const form = document.getElementById('chat-form');
    const msgBox = document.querySelector('textarea[name="message"]');
    const sendBtn = document.querySelector('#chat-form button[type="submit"]');

    if (form) {
      form.addEventListener('submit', () => {
        setTimeout(refreshEmotionPanel, 150);
      });
    }

    // âœ… Enterë¡œ ì „ì†¡ / Shift+EnterëŠ” ì¤„ë°”ê¿ˆ
    if (msgBox && form) {
      msgBox.addEventListener('keydown', function(event) {
        if (event.isComposing || event.keyCode === 229) return;
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          if (!msgBox.disabled && sendBtn && !sendBtn.disabled) {
            form.submit();
          }
        }
      });
    }

    // ë°ì´í„° ë™ì˜ ëª¨ë‹¬/ê°€ë“œ
    function openConsent(){ document.getElementById('consentModal').style.display='flex'; }
    function closeConsent(){ document.getElementById('consentModal').style.display='none'; }

    const agreeChk = document.getElementById('agreeChk');
    const agreeBtn = document.getElementById('agreeBtn');
    if (agreeChk && agreeBtn){
      agreeChk.addEventListener('change', ()=> { agreeBtn.disabled = !agreeChk.checked; });
    }

    function applyConsentGuard() {
      const on = !!CONSENT_OK;
      if (msgBox) { msgBox.disabled = !on; msgBox.placeholder = on ? 'í•˜ê³  ì‹¶ì€ ë§ì„ ì ì–´ì£¼ì„¸ìš”...' : 'ë°ì´í„° ë™ì˜ í›„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'; }
      if (sendBtn) { sendBtn.disabled = !on; }
      if (!on || NEED_CONSENT) openConsent();
    }

    // ---- ìŠ¤í‹°ì»¤ ìœ í‹¸
    let stickerTimer = null;
    let lastStickerKey = "";

    function showStickerIfAny(st) {
      const box = document.getElementById('sticker-toast');
      if (!box) return;

      if (!st || !st.type) { box.style.display = 'none'; return; }

      const key = st.type + '::' + (st.text || '');
      if (key === lastStickerKey) return;
      lastStickerKey = key;

      const img = document.getElementById('sticker-img');
      const cap = document.getElementById('sticker-caption');

      const MAP = {
        cheer:   { src: '/static/stickers/cheer.png',    fallback: 'ğŸ¤—', text: 'í˜ë‚´ìš”!'   },
        congrats:{ src: '/static/stickers/congrats.png', fallback: 'ğŸ‰', text: 'ì¶•í•˜í•´ìš”!' },
      };
      const meta = MAP[st.type] || null;

      cap.textContent = st.text || (meta ? meta.text : '');

      if (meta) {
        const testImg = new Image();
        testImg.onload = () => { img.src = meta.src; img.style.display = 'block'; };
        testImg.onerror = () => { img.src = ''; img.style.display = 'none'; cap.textContent = (st.text || meta.text) + ' ' + meta.fallback; };
        testImg.src = meta.src;
      } else {
        img.src = ''; img.style.display = 'none';
      }

      box.style.display = 'flex';
      if (stickerTimer) clearTimeout(stickerTimer);
      stickerTimer = setTimeout(() => { box.style.display = 'none'; }, 5000);
    }

    // ======== STT: ë¸Œë¼ìš°ì € Web Speech API (final-only) + Whisper í´ë°± ========
    const micBtn = document.getElementById('micBtn');
    const textArea = document.querySelector('textarea[name="message"]');

    let rec;
    let usingWebAPI = false;
    let capturing = false;

    let commitBuf = "";
    let baseAtStart = "";

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition || null;
    if (SR) {
      rec = new SR();
      rec.lang = 'ko-KR';
      rec.interimResults = false;
      rec.continuous = true;

      rec.onstart = () => {
        usingWebAPI = true;
        capturing = true;
        micBtn.textContent = 'ğŸ›‘ ë©ˆì¶”ê¸°';
        baseAtStart = (textArea?.value || '').trim();
        commitBuf = baseAtStart;
      };

      rec.onresult = (e) => {
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const res = e.results[i];
          if (!res.isFinal) continue;
          const piece = (res[0]?.transcript || "").trim();
          if (!piece) continue;
          if (commitBuf && !commitBuf.endsWith(' ')) commitBuf += ' ';
          commitBuf += piece;
        }
        if (textArea) textArea.value = commitBuf;
      };

      rec.onerror = (e) => {
        console.warn('SpeechRecognition error', e);
        usingWebAPI = false;
        capturing = false;
        micBtn.textContent = 'ğŸ¤ ë§í•˜ê¸°';
        if (textArea) textArea.value = commitBuf;
        stopMediaRecording();
      };

      rec.onend = () => {
        if (textArea) textArea.value = commitBuf;
        capturing = false;
        micBtn.textContent = 'ğŸ¤ ë§í•˜ê¸°';
      };
    }

    // ---- Whisper í´ë°± (/stt)
    let mediaStream = null;
    let mediaRecorder = null;
    let chunks = [];

    async function startMediaRecording() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ë§ˆì´í¬ ì ‘ê·¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(mediaStream, { mimeType: 'audio/webm' });
        chunks = [];

        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) chunks.push(e.data);
        };
        mediaRecorder.onstop = async () => {
          const blob = new Blob(chunks, { type: 'audio/webm' });
          chunks = [];
          const fd = new FormData();
          fd.append('audio', blob, 'speech.webm');
          try {
            const res = await fetch('/stt', { method: 'POST', body: fd });
            const data = await res.json();
            if (data && data.ok && data.text) {
              const prev = (textArea.value || '').trim();
              textArea.value = prev ? (prev + ' ' + data.text) : data.text;
            } else {
              alert('ìŒì„± ì¸ì‹ ì‹¤íŒ¨: ' + (data && data.error ? data.error : 'unknown'));
            }
          } catch (err) {
            console.warn('STT upload error', err);
            alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ìŒì„± ì¸ì‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          } finally {
            if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
            mediaStream = null;
            mediaRecorder = null;
          }
        };

        mediaRecorder.start();
        capturing = true;
        micBtn.textContent = 'ğŸ›‘ ë©ˆì¶”ê¸°';
      } catch (err) {
        console.warn('getUserMedia error', err);
        alert('ë§ˆì´í¬ ì ‘ê·¼ì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
      }
    }

    function stopMediaRecording() {
      try { if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop(); } catch (e) {}
      try { if (mediaStream) mediaStream.getTracks().forEach(t => t.stop()); } catch (e) {}
      mediaRecorder = null;
      mediaStream = null;
      capturing = false;
      micBtn.textContent = 'ğŸ¤ ë§í•˜ê¸°';
    }

    if (micBtn) {
      micBtn.addEventListener('click', async () => {
        if (!{{ 'true' if consent_ok else 'false' }}) {
          alert('ë°ì´í„° ë™ì˜ í›„ ìŒì„± ì…ë ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          return;
        }
        if (capturing) {
          if (usingWebAPI && rec) { try { rec.stop(); } catch(e) {} }
          else { stopMediaRecording(); }
          return;
        }
        if (rec) {
          try { rec.start(); return; } catch (e) {
            console.warn('SpeechRecognition start failed, fallback to MediaRecorder', e);
            usingWebAPI = false;
          }
        }
        await startMediaRecording();
      });
    }

    // ì´ˆê¸° ì ìš©
    applyConsentGuard();
    refreshEmotionPanel();
    setInterval(refreshEmotionPanel, 3000);

    const chat = document.getElementById('chat-window');
    if (chat) chat.scrollTop = chat.scrollHeight;
  </script>
</body>
</html>
